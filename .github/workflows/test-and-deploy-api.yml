name: Test and deploy the Sentiment analysis API

on:
  push:
    branches:
      - main
    paths:
      - 'api/main.py'
      - 'api/tests/test_api.py'
      - '**/*.yml'

jobs:
  build-and-test:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true
      
      # Force le runner à remplacer
      # tous les pointeurs LFS par les vrais fichiers.
      - name: Pull LFS files
        run: git lfs pull
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt # Fichier listant les dépendances (fastapi, torch, etc.)
          pip install httpx pytest # Pour les tests

      - name: Run tests
        run: |
          export TESTING=true   
          export PYTHONPATH=$PYTHONPATH:./api
          pytest

  build-and-deploy:
    needs: build-and-test # Ce job ne s'exécute que si les tests passent
    runs-on: self-hosted
    steps:
      # Étape 1 : Récupérer le code à jour (y compris le Dockerfile)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true # Important pour que le Dockerfile puisse accéder au modèle

      # Étape 2 : S'assurer que les fichiers LFS sont présents
      - name: Pull LFS files
        run: git lfs pull

      # Étape 3 : Construire l'image Docker
      # Nous la taguons avec le nom que votre main.tf attend
      - name: Build Docker image
        run: |
          docker build -t mycustom/ml-image:latest -f iac/Dockerfile .

      # Étape 4 : Appliquer la configuration OpenTofu
      # Tofu verra que l'ID de 'mycustom/ml-image:latest' a changé
      # et recréera le conteneur, ce qui déploie votre API.
      - name: Apply OpenTofu deployment
        run: |
          cd ${SENTIMENT_ANALYSIS_IAC}/iac # Utilise votre variable d'environnement
          tofu init
          tofu apply -auto-approve

      # Étape 5 (Optionnelle mais recommandée) : Nettoyer les anciennes images
      - name: Prune old Docker images
        if: always() # S'exécute même si l'étape tofu échoue
        run: |
          docker image prune -f